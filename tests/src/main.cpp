#include <filesystem>
#include <iostream>
#include <fstream>
#include <sstream>
#include <vector>
#include <random>
#include <cmath>
#include <algorithm>
#include <numeric>
#include <unordered_set>
#include <unordered_map>
#include <ctime>
#include <map>
#include <set>

#include <data.hpp>
#include <crypt.hpp>
#include <model.hpp>


double trainRandomForestModel(bool verbose = false) {
    std::vector<std::vector<double>> allFeatures, trainFeatures, testFeatures;
    std::vector<int> allLabels, trainLabels, testLabels;
    std::vector<std::string> allHeaders;

    // Load data from CSV file
    for (auto& csvPath : std::filesystem::directory_iterator("./inc/malware")) {
        if (!loadCSV(csvPath.path().string(), allFeatures, allLabels, allHeaders)) {
            std::cerr << "Failed to load CSV file!" << std::endl;
            return 0;
        }
    }

    if (verbose) {
        std::cout << "Loaded " << allFeatures.size() << " total data points" << std::endl;
    }

    // Split data into train and test sets
    trainTestSplit(allFeatures, allLabels, trainFeatures, trainLabels, testFeatures, testLabels);

    // Training features and labels MUST be sorted
    sortData(trainFeatures, trainLabels);

    clock_t begin = clock();

    RandomForest forest(10, 5, 1);
    forest.train(trainFeatures, trainLabels);

    clock_t end = clock();
    double elapsed_ms = double(end - begin) / CLOCKS_PER_SEC * 1000.0;

    if (verbose) {
        std::cout << "Training completed in " << elapsed_ms << " ms" << std::endl;
    }

    // Evaluate the accuracy of the model
    double accuracy = forest.calculateAccuracy(testFeatures, testLabels);

    if (verbose) {
        std::cout << "Estimated accuracy: " << accuracy << std::endl;
    }

    // Save the model to a file
    forest.saveModel("./inc/model.bin");

    if (verbose) {
        std::cout << "Model saved successfully" << std::endl;
    }

    return accuracy;
}

int main() {

    // TODO: User interaction

    // TODO: Extend verbose efficacy
    bool verbose = true;
    bool train = false;

    // Train the model to ./inc/model.bin
    if (train) {
        double accuracy = trainRandomForestModel(verbose);
        std::cout << "Model trained successfully" << std::endl;
        std::cout << "Estimated accuracy: " << accuracy << std::endl;
    }

    // Load the model from ./inc/model.bin
    RandomForest forest("./inc/model.bin");

    // Get features from a single file
    std::vector<std::string> headers;
    std::vector<double> features;

    std::string filePath = "./inc/m.exe";

    fileAttr(filePath, headers, features);

    // Evaluate the accuracy of the model
    double predictedLabel = forest.predict(features);
    std::cout << "Prediction: " << predictedLabel << std::endl;

    // TODO: Generate a report of the file's features

    return 0;
}
